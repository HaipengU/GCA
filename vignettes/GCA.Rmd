---
title: "GCA: An R package for genetic connectedness analysis using pedigree and genomic data"
output: 
  prettydoc::html_pretty:
    theme: architect
    highlight: vignette
    toc: true
    toc_depth: 4
bibliography: references.bib
vignette: >
  %\VignetteIndexEntry{GCA}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, warning=FALSE, message=FALSE)
```

## Introduction
Genetic connectedness quantifies the extent of linkage between individuals across management units. The concept of genetic connectedness can be extended to measure the connectedness level between training and testing sets in whole-genome prediction. However, there is no user-friendly software tool available to compute a comprehensive list of connectedness statistics. Therefore we developed the genetic connectedness analysis R package, GCA, which utilizes pedigree and genomic data to measure the connectedness between individuals across units.

## Connectedness Statistics
The connectedness statistics implemented in this R package can be classified into two core functions: prediction error variance (PEV) and variance of unit effect estimates (VE). The PEV-derived metrics include prediction error variance of differences (PEVD), coefficient of determination (CD), and prediction error correlation (r). These PEV-derived metrics can be summarized at the unit level as the average PEV of all pairwise differences between individuals across units, average PEV within and across units, or using a contrast vector. VE-derived metrics include variance of differences in management unit effects (VED), coefficient of determination of VED (CDVED), and connectedness rating (CR). Three correction factors accounting for the number of fixed effects can be applied for each VE-derived metric. These include no correction (0), correcting for one fixed effect (1), and correcting for two or more fixed effects (2). The R code is integrated with C++ to improve computational speed using the Rcpp package [@rcpp]. We expect this R package will provide a comprehensive and effective tool for genetic connectedness analysis and whole-genome prediction. A comprehensive list of all connectedness statistics implemented in this R package can be summarized as following. The details of these connectedness statistics can be found in the [paper](https://www.biorxiv.org/content/10.1101/696419v2) [@Yu2019].

* Prediction error variance (PEV)
  - Prediction error variance of difference (PEVD)
    - Individual Average PEVD
    - Group Average PEVD 
    - Contrast PEVD
  - Coefficient of Determination (CD)
    - Individual Average CD 
    - Group Average CD 
    - Contrast CD 
  - Prediction Error Correlation (r)
    - Individual average r
    - Group average r 
    - Contrast r
* Variance of unit effect estimates (VE)
  - Variance of differences in unit effects (VED)
    - VED0
    - VED1
    - VED2
  - Coefficient of Determination of VED (CDVED)
    - CDVED0
    - CDVED1
    - CDVED2
  - Connectedness Rating (CR)
    - CR0 
    - CR1
    - CR2
  
## Application of the GCA package
### Installing the GCA package from GitHub
```{r, results='hide', eval = FALSE}
install.packages("devtools")
library(devtools)
install_github('HaipengU/GCA')
library(GCA)
```
### Data preparation
The dataset `GCcattle` contains two objects `cattle.pheno` and `cattle.W`, which include phenotypic and marker information, respectively. The details can be obtained by typing `?GCcattle`. 
```{r message = FALSE}
library(GCA)
data(GCcattle)
dim(cattle.pheno) # phenotypes + fixed effects
dim(cattle.W) # marker matrix
```

The heritability of simulated phenotype was set to 0.6 with $\sigma^2_a$ = 0.6 and $\sigma^2_e$ = 0.4.
```{r}
sigma2a <- 0.6 # additive genetic variance
sigma2e <- 0.4 # residual variance
```

Below we construct two incidence matrices and a genomic relationship matrix. The X1 and X2 contain one and two fixed effects, respectively.
```{r}
X1 <- model.matrix(~ -1 + factor(cattle.pheno$Unit)) # incidence matrix of unit effect with intercept excluded
X2 <- model.matrix(~ -1 + factor(cattle.pheno$Unit) + factor(cattle.pheno$Sex)) # incidence matrix of unit effect and sex
G <- computeG(cattle.W) # genomic relationship matrix
```

### Available connectedness statistics in the GCA package
The following section lists all available connectedness statistics in the GCA package, which are available by setting the argument of `statistic`.  

- PEVD_IdAve : Individual average PEVD, the optional argument of 'scale' is available. 
- PEVD_GrpAve : Groupd average PEVD, the optional arguments of 'scale' and 'diag' are available.
- PEVD_contrast: Contrast PEVD, the optional argument of 'scale' is available.
- CD_IdAve : Individual average CD.
- CD_GrpAve : Group average CD, the optional argument of 'diag' is available. 
- CD_contrast : Contrast CD.
- r_IdAve : Individual average r.
- r_GrpAve : Group average r, the optional argument of 'diag' is available.
- r_contrast : Contrast r. 
- VED0 : Variance of estimate of unit effects differences. The optional argument of 'scale' is available.
- VED1 : Variance of estimate of unit effects differences with the correction of unit effect. The optional argument of 'scale' is available.
- VED2 : Variance of estimate of unit effects differences with the correction of unit effect and additional fixed effects. The additional argument of 'Uidx' is required and the optional argument of 'scale' is available. 
- CDVED0 : Coefficient of determination of VED, the optional argument of 'diag' is available.
- CDVED1 : Coefficient of determination of VED with the correction of unit effect. The optional argument of 'diag' is available.
- CDVED2 : Coefficient of determination of VED with the correction of unit effect and additional fixed effects. The additional argument of 'Uidx' is required and the optional argument of 'diag' is available.
- CR0 : Connectedness rating. 
- CR1 : Connectedness rating with the correction of unit effect. 
- CR2 : Connectedness rating with the correction of unit effect and additional fixed effects. The additional argument of 'Uidx' is required. 

### Examples of connectedness measures across units
Below we list some examples of connectedness statistics in the GCA package.

#### PEV-derived statistic: PEVD_IdAve (pairwise vs. overall)
The `gca` function is the main engine in the GCA package. The following example illustrates the pairwise individual average PEVD between all units. Based on the results, units 1 and 8 are the most connected (PEVD_IdAve = 0.2818) and the least connected units are units 4 and 6 (PEVD_IdAve = 0.3083). The PEVD statistic ranges from 0 to 1, with the smaller value indicates more connectedness.
```{r}
PEVD_IdAve <- gca(Kmatrix = G, Xmatrix = X1, sigma2a = sigma2a, sigma2e = sigma2e, 
                  MUScenario = as.factor(cattle.pheno$Unit), statistic = 'PEVD_IdAve', 
                  NumofMU = 'Pairwise')
round(PEVD_IdAve, digits = 4)
```

Alternatively, the `gca` function can return an overall connectedness, which averages all pairwise PEVD_IdAve between units by setting `NumofMU` to `'Overall'`.
```{r}
PEVD_IdAve <- gca(Kmatrix = G, Xmatrix = X1, sigma2a = sigma2a, sigma2e = sigma2e, 
                  MUScenario = as.factor(cattle.pheno$Unit), statistic = 'PEVD_IdAve', 
                  NumofMU = 'Overall')
PEVD_IdAve

```

Following the above example, the group average PEVD and contrast PEVD can be easily calculated by changing the argument `statistic` to PEVD_GrpAve and PEVD_contrast, respectively.

#### PEV-derived statistic: CD_IdAve
The pairwise individual average CD statistic between units is shown in the following example. The most connected units was found between units 1 and 8 (CD_IdAve = 0.8590). On the other hand, the least connected design was found between units 4 and 6 (CD_IdAve = 0.8455). The larger CD statistics indicates the greater connectedness. 
```{r}
CD_IdAve <- gca(Kmatrix = G, Xmatrix = X1, sigma2a = sigma2a, sigma2e = sigma2e, 
                MUScenario = as.factor(cattle.pheno$Unit), statistic = 'CD_IdAve', 
                NumofMU = 'Pairwise')
round(CD_IdAve, digits = 4)
```

#### PEV-derived statistic: CD_GrpAve
A group average CD, is computed in the following example. We can see that the most connected units are units 2 and 7 (CD_GrpAve = 0.8073), while units 1 and 6 (CD_GrpAve = 0.7615) the least connectedness.
```{r}
CD_GrpAve <- gca(Kmatrix = G, Xmatrix = X1, sigma2a = sigma2a, sigma2e = sigma2e, 
               MUScenario = as.factor(cattle.pheno$Unit), statistic = 'CD_GrpAve', 
               NumofMU = 'Pairwise')
round(CD_GrpAve, digits = 4)
```

#### VE-derived statistic: VED0 
The following example illustrates the VED0 statistic. Here, the smaller value indicates the greater connectedness. We can see that the most connected units are found between units 1 and 8 (VED0 = 0.0124). On the other hand, units 4 and 6 (VED0 = 0.0445) shows the least connectedness.
```{r}
VED0  <- gca(Kmatrix = G, Xmatrix = X1, sigma2a = sigma2a, sigma2e = sigma2e, 
             MUScenario = as.factor(cattle.pheno$Unit), statistic = 'VED0', 
             NumofMU = 'Pairwise')
round(VED0, digits = 4)
```
#### VE-derived statistic: CDVED1
An example of CDVED1 statistic, which accounts for the number of observations in the unit is shown in the following example. The most connected units are found between units 2 and 7 (CDVED1 = 0.8073), whereas units 1 and 6 (CDVED1 = 0.7615) shows the least connectedness. 
```{r}
CDVED1 <- gca(Kmatrix = G, Xmatrix = X1, sigma2a = sigma2a, sigma2e = sigma2e, 
              MUScenario = as.factor(cattle.pheno$Unit), statistic = 'CDVED1', 
              NumofMU = 'Pairwise')
round(CDVED1, digits = 4)
```

#### VE-derived statistic: CDVED2 
This example shows the calculation of CDVED2, where two fixed effects (units and sex) are accounted for using the correction factor. The larger CDVED2 value indicates the greater connectedness. We can see that the most connected units are between units 2 and 7 (CDVED2 = 0.8072), while units 1 and 6 (CDVED2 = 0.7615) shows the least connectedness.
```{r}
CDVED2  <- gca(Kmatrix = G, Xmatrix = X2, sigma2a = sigma2a, sigma2e = sigma2e, 
           MUScenario = as.factor(cattle.pheno$Unit), statistic = 'CDVED2', 
           NumofMU = 'Pairwise', Uidx = 8)
round(CDVED2, digits = 4)
```

## Authors
- Haipeng Yu (<haipengyu@vt.edu>)
- Gota Morota (<morota@vt.edu>) 

## References 


